<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tashu Cloudinary Gallery â€” Blue Remix</title>
  <style>
    :root{
      --blue1:#e6f6ff;
      --blue2:#ccf0ff;
      --accent:#3aa0ff;
      --soft:#bfe9ff;
      --panel:#0b0b0d; /* black stage */
      --card-radius:12px;
      --gutter:14px;
      --shadow: 0 18px 40px rgba(10,20,30,.42);
      --muted:#9bb7d8;
    }
    *{box-sizing:border-box}
    body{
      margin:18px;
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(600px 200px at 10% 0%, rgba(58,160,255,.06), transparent 20%),
                  linear-gradient(180deg,var(--blue1),var(--blue2));
      color:#062134;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px;
    }
    .brand{
      display:flex;align-items:center;gap:12px;
    }
    .logo{
      width:54px;height:54px;border-radius:14px;
      background:linear-gradient(135deg,var(--accent),#7fd1ff);
      display:grid;place-items:center;color:#fff;font-weight:900;font-size:18px;box-shadow:var(--shadow);
    }
    h1{margin:0;font-size:20px;color:#024;letter-spacing:.2px}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .controls{display:flex;gap:10px;align-items:center}
    .btn{
      display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:0;cursor:pointer;font-weight:700;
      background:linear-gradient(90deg,var(--accent),#6ecbff);color:#021831;box-shadow: 0 10px 30px rgba(10,150,255,.12);
    }
    input[type=file]{display:none}

    /* gallery stage (black) */
    .stage{
      background: linear-gradient(180deg,#07070a,#0e1220 80%);
      border-radius:18px;
      padding:20px;
      margin-top:18px;
      box-shadow: 0 28px 80px rgba(4,10,20,.6);
      border: 1px solid rgba(255,255,255,.03);
    }
    .stage-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;color:var(--muted)}
    .stage-title{color:#e6f7ff;font-weight:800;letter-spacing:.6px}

    /* grid of tiles */
    #gallery{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap:var(--gutter);
    }

    .tile{
      position:relative;
      border-radius:var(--card-radius);
      overflow:hidden;
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.03);
      min-height:130px;
      display:block;
      transform-origin:center;
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
      transition: transform .28s cubic-bezier(.2,.9,.2,1), box-shadow .2s;
      will-change: transform, opacity;
    }

    .tile:hover{ transform: translateY(-6px) scale(1.02); box-shadow: 0 32px 60px rgba(0,0,0,.6); }

    .tile img{
      width:100%; height:100%; object-fit:cover; display:block; min-height:110px;
      transition: transform .45s ease;
      transform-origin:center;
    }
    .tile:hover img{ transform: scale(1.05); }

    /* delete button - black circular with white icon */
    .delete-btn{
      position:absolute; right:10px; top:10px; z-index:6;
      width:40px;height:40px;border-radius:50%;border:0;background:#000;color:#fff;
      display:grid;place-items:center;font-weight:900;cursor:pointer;box-shadow: 0 10px 30px rgba(0,0,0,.55);
      transition: transform .18s ease, opacity .12s;
      opacity:.96;
    }
    .delete-btn:hover{ transform: scale(1.06) rotate(-6deg); }
    .delete-btn:active{ transform: scale(.98) rotate(-2deg); }

    .delete-btn[aria-busy="true"]{ opacity:.6; cursor:progress; }

    /* entrance animation for new tiles */
    .pop-in{
      animation: popIn .56s cubic-bezier(.2,.9,.2,1) both;
    }
    @keyframes popIn{
      0%{ opacity:0; transform: translateY(22px) scale(.8) rotate(-2deg); filter: blur(6px); }
      60%{ opacity:1; transform: translateY(-6px) scale(1.03) rotate(1deg); filter: blur(0); }
      100%{ transform: translateY(0) scale(1) rotate(0); }
    }

    /* sparkle burst when upload completes */
    .sparkle {
      position:absolute; inset:0; pointer-events:none; display:block;
    }
    .sparkle::after{
      content:"";
      position:absolute; left:50%; top:18%;
      width:18px; height:18px;
      transform:translateX(-50%) scale(0);
      background: radial-gradient(circle at 30% 30%, #fff, #b9f0ff 35%, transparent 60%);
      border-radius:50%;
      animation: sparklePop .7s ease forwards;
      box-shadow: 0 0 24px rgba(66,200,255,.4);
      opacity:.95;
    }
    @keyframes sparklePop{
      0%{ transform:translateX(-50%) scale(.1); opacity:0; }
      50%{ transform:translateX(-50%) scale(1.8); opacity:1; }
      100%{ transform:translateX(-50%) scale(.8); opacity:0; }
    }

    /* delete animation: fly out and fade */
    .fly-out{
      animation: flyOut .6s cubic-bezier(.2,.8,.2,1) forwards;
    }
    @keyframes flyOut{
      0%{ opacity:1; transform: translateY(0) rotate(0) scale(1); filter: blur(0); }
      40%{ transform: translateY(-12px) rotate(12deg) scale(.92); filter: blur(.6px); opacity:.9; }
      100%{ opacity:0; transform: translate(40vw,-30vh) rotate(40deg) scale(.3); filter: blur(6px); }
    }

    /* empty state */
    .empty{
      text-align:center;color:var(--muted);padding:32px;border-radius:10px;border:1px dashed rgba(255,255,255,.03);
      margin-top:6px;
    }

    /* small utility */
    #status{margin-top:12px;color:var(--muted);font-size:13px}
    @media (max-width:520px){
      .logo{width:44px;height:44px;font-size:15px}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">A</div>
      <div>
        <h1>ðŸ’™ ALOK'S BLUE GALLERY</h1>
        <p class="lead">Upload photos â€” theyâ€™ll land on the black stage with animations.</p>
      </div>
    </div>

    <div class="controls">
      <label for="uploader" class="btn" title="Upload photo">ï¼‹ Upload</label>
      <input id="uploader" type="file" accept="image/*" />
      <button id="refresh" class="btn" title="Refresh gallery">Refresh</button>
    </div>
  </header>

  <main class="stage" role="main" aria-label="Photo stage">
    <div class="stage-head">
      <div class="stage-title">Photos</div>
      <div style="color:var(--muted);font-size:13px" id="count">â€”</div>
    </div>

    <div id="gallery" aria-live="polite" aria-busy="false"></div>

    <div id="status">Loading imagesâ€¦</div>
  </main>

  <script>
    // ===== cloudinary client-only info (safe) =====
    const CLOUD_NAME = 'dkmk0hsfk';   // replace with yours if needed
    const UPLOAD_PRESET = 'unsigned_gallery';
    const FOLDER = 'gallery';

    // UI nodes
    const uploader = document.getElementById('uploader');
    const galleryEl = document.getElementById('gallery');
    const statusEl = document.getElementById('status');
    const countEl = document.getElementById('count');
    const refreshBtn = document.getElementById('refresh');

    function setStatus(s){ statusEl.textContent = s; }
    function setCount(n){ countEl.textContent = n + ' photos'; }

    // helper: create tile element from image metadata
    function createTile(imgObj, animate = false){
      const d = document.createElement('div');
      d.className = 'tile';
      d.dataset.publicId = imgObj.public_id || imgObj.publicId || '';
      // image url transform for display
      const src = (imgObj.secure_url || imgObj.url || '').replace('/upload/', '/upload/q_auto,f_auto,w_1100,h_900,c_fill/');
      const img = document.createElement('img');
      img.src = src;
      img.alt = imgObj.original_filename || imgObj.public_id || 'photo';
      d.appendChild(img);

      // sparkle overlay used only when animate==true
      if (animate){
        const s = document.createElement('span');
        s.className = 'sparkle';
        d.appendChild(s);
      }

      // delete button (black circular)
      const btn = document.createElement('button');
      btn.className = 'delete-btn';
      btn.type = 'button';
      btn.title = 'Delete photo';
      btn.setAttribute('aria-label', 'Delete photo');
      btn.innerHTML = 'ðŸ—‘';
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        await handleDelete(d, btn);
      });
      d.appendChild(btn);

      if (animate) d.classList.add('pop-in');

      return d;
    }

    // fetch images from your serverless list endpoint
    async function fetchImages(){
      galleryEl.setAttribute('aria-busy','true');
      setStatus('Loading imagesâ€¦');
      try {
        const res = await fetch('/.netlify/functions/list-images');
        if (!res.ok) {
          const t = await res.text();
          setStatus('Failed to load images');
          console.error(t);
          galleryEl.setAttribute('aria-busy','false');
          return;
        }
        const json = await res.json();
        const items = json.images || json.resources || [];
        galleryEl.innerHTML = '';
        if (items.length === 0){
          galleryEl.innerHTML = '<div class="empty">No photos yet â€” upload one!</div>';
          setCount(0);
          setStatus('');
          galleryEl.setAttribute('aria-busy','false');
          return;
        }
        items.forEach(item => {
          const tile = createTile(item, false);
          galleryEl.appendChild(tile);
        });
        setCount(items.length);
        setStatus('Loaded ' + items.length + ' images');
        galleryEl.setAttribute('aria-busy','false');
      } catch (err) {
        console.error(err);
        setStatus('Error loading images');
        galleryEl.setAttribute('aria-busy','false');
      }
    }

    // upload handler: animate incoming tile
    uploader.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) { alert('Please choose an image file'); return; }
      if (file.size > 14 * 1024 * 1024) { alert('Max 14 MB'); return; }

      try {
        setStatus('Uploadingâ€¦');
        const form = new FormData();
        form.append('file', file);
        form.append('upload_preset', UPLOAD_PRESET);
        if (FOLDER) form.append('folder', FOLDER);

        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, {
          method: 'POST', body: form
        });
        if (!res.ok) throw new Error('Upload failed');
        const data = await res.json();

        // Add animated tile to top
        const tile = createTile(data, true);
        // Insert at start then scroll to it a bit
        galleryEl.insertBefore(tile, galleryEl.firstChild);
        setCount((parseInt(countEl.textContent) || 0) + 1);
        setStatus('Upload complete');
        // after a short time, remove sparkle element if any
        setTimeout(()=> {
          const sp = tile.querySelector('.sparkle');
          if (sp) sp.remove();
          tile.classList.remove('pop-in'); // keep tile stable
        }, 900);

      } catch (err) {
        console.error(err);
        alert('Upload failed: ' + (err.message || err));
        setStatus('Upload failed. Check cloud name & preset.');
      } finally {
        uploader.value = '';
      }
    });

    // Delete logic: animate tile then call server delete endpoint
    async function handleDelete(tileEl, btn){
      const publicId = tileEl.dataset.publicId;
      if (!publicId){ alert('Missing id. Cannot delete.'); return; }
      if (!confirm('Delete this photo? This action is permanent.')) return;

      try {
        btn.setAttribute('aria-busy','true');
        btn.disabled = true;
        btn.innerText = 'â€¦';

        // animate tile (fly out)
        tileEl.classList.add('fly-out');

        // wait slightly so user sees animation before removing from DOM/pinging server
        await new Promise(res => setTimeout(res, 420));

        // call deletion endpoint
        const res = await fetch('/.netlify/functions/delete-image', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ public_id: publicId })
        });
        if (!res.ok){
          const txt = await res.text();
          console.error('delete failed', txt);
          alert('Delete failed. Check server logs.');
          // revert animation (simple approach: remove fly-out and refresh)
          tileEl.classList.remove('fly-out');
          btn.removeAttribute('aria-busy');
          btn.innerText = 'ðŸ—‘';
          return;
        }
        const json = await res.json();
        if (json.result === 'ok' || json.result === 'deleted' || json.result === 'not_found'){
          // remove element from DOM
          tileEl.remove();
          setStatus('Deleted');
          // optionally refresh counts or list
          const current = Math.max(0, (parseInt((countEl.textContent||'0')) || 0) - 1);
          setCount(current);
        } else {
          alert('Delete response: ' + JSON.stringify(json));
          tileEl.classList.remove('fly-out');
          btn.removeAttribute('aria-busy');
          btn.innerText = 'ðŸ—‘';
        }
      } catch (err) {
        console.error(err);
        alert('Delete failed: ' + (err.message || err));
      }
    }

    // refresh button
    refreshBtn.addEventListener('click', fetchImages);

    // initial load
    fetchImages();
  </script>
</body>
</html>
